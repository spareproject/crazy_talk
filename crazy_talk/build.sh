!/bin/env bash
###############################################################################################################################################################################################################
clear;cat /etc/banner
mkdir -p ./rootfs/boot
mkdir -p ./mount/
###############################################################################################################################################################################################################
if [[ ! -b ${1} ]];then echo "${1} doesnt exist...";fi
if [[ ${1: -1} == [0-9] ]];then echo "takes device not partition fucked up this way more than once...";exit;fi
lsblk
unset finish;while [[ ${finish} != @("y"|"n") ]];do read -r -p "about to mkfs.vfat ${1}1  continue (y/n)? " finish;done
if [[ ${finish} == "n" ]];then clear;cat /etc/banner;echo "i always say putting prompts like this does nothing but encourage bad behaviour learn to fuck up less...";fi
###############################################################################################################################################################################################################
dev=${1}
boot=${dev}1
keys=${dev}2
random=${dev}3
###############################################################################################################################################################################################################

# keep forgetting this shit... not exactly good in an upload
systemctl start pacman-init
if [[ ! $(mount | grep /var/cache/pacman/pkg) ]];then mount --bind /mnt/storage/old/storage/pkg /var/cache/pacman/pkg;fi

mkfs.vfat -F32 ${boot}
###############################################################################################################################################################################################################
pacstrap -C ./pacman.conf -cGMd ./rootfs $(for i in $(cat packages);do if [[ ! $(grep "#" <<< ${i}) ]];then echo -n "${i} " ;fi;done)
cp -arfv airootfs/* rootfs/
###############################################################################################################################################################################################################
mount ${boot} ./mount
mv ./rootfs/boot/* ./mount/
umount ./mount/
###############################################################################################################################################################################################################
arch-chroot ./rootfs /root/install.sh ${dev}
###############################################################################################################################################################################################################
idproduct=$(udevadm info ${dev} | grep -e ID_MODEL_ID | sed 's/E: ID_MODEL_ID=//')
idvendor=$(udevadm info ${dev} | grep -e ID_VENDOR_ID | sed 's/E: ID_VENDOR_ID=//')
iserial=$(udevadm info ${dev} | grep -e ID_SERIAL_SHORT | sed 's/E: ID_SERIAL_SHORT=//')
sed -i -e "s/IDVENDOR/${idvendor}/" -e "s/IDPRODUCT/${idproduct}/" -e "s/SERIAL/${iserial}/" ./rootfs/root/09-gnupg.rules
###############################################################################################################################################################################################################
mount ${boot} ./mount
mksquashfs ./rootfs ./mount/rootfs.squashfs
umount ./mount
echo " quick and dirty... "
###############################################################################################################################################################################################################
