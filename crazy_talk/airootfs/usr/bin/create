#!/bin/env bash
###############################################################################################################################################################################################################
if [[ $# != 2 ]];then echo -e "${0} - help\narg0 - rawfs name\narg1 - size";exit;fi
###############################################################################################################################################################################################################
umask 077
###############################################################################################################################################################################################################
if [[ ! $(mount | grep /mnt) ]];then echo "internal storage isnt mounted";exit;fi
if [[ ! -d /tmp/user && ! $(pgrep gpg-agent) ]];then echo "gnupg not loaded";exit;fi
if [[ ! -d /mnt/luks/${1} && ! -d /mnt/rawfs/${name} ]];then echo "rawfs &| key dont exist";fi
###############################################################################################################################################################################################################
if [[ ! -d /mnt/mount/${1} ]];then mkdir -p /mnt/mount/${1};fi
dd if=/dev/random bs=1 count=8192 | gpg --homedir /tmp/user -e > /mnt/luks/${1}
fallocate -l ${2} /mnt/rawfs/${1}
gpg --homedir /tmp/user -d /mnt/luks/${1} 2>/dev/null|
cryptsetup --cipher aes-xts-plain64 --key-size 512 --hash sha512 --iter-time 5000 --key-file - --type=plain --offset 0 open /mnt/rawfs/${1} ${1} 
mkfs.ext4 /dev/mapper/${1}
mount /dev/mapper/${1} /mnt/mount/${1}
###############################################################################################################################################################################################################
