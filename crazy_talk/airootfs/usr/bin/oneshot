#!/bin/env bash
###############################################################################################################################################################################################################
umask 077
###############################################################################################################################################################################################################
clear;cat /etc/banner
while [[ ! -b /dev/archiso1 && ! -b /dev/archiso2 && ! -b /dev/archiso3 ]];do
read -p "plugin usb... (hit enter)"
if [[ ! -b /dev/archiso1 && ! -b /dev/archiso2 && ! -b /dev/archiso3 ]];then clear;cat /etc/banner;echo "device /dev/archiso does not exist... ";fi
done
###############################################################################################################################################################################################################
if [[ ${USER} == "root" ]];then
mkdir /tmp/mount
mkdir /tmp/user
mount -o ro,noload,noexec,nosuid,nodev,noatime /dev/archiso2 /tmp/mount
cp -ar /tmp/mount/user/* /tmp/user
cp /tmp/mount/trigger.asc /tmp
touch /tmp/unlocked
sync
umount /tmp/mount
rmdir  /tmp/mount
###############################################################################################################################################################################################################
read -rp "enter pin: " PIN
gpg --homedir /tmp/user --passphrase-fd 0 -d /tmp/trigger.asc 2>/dev/null <<< $(dd if=/dev/archiso3 bs=1 count=100 ibs=1 skip=${PIN} 2>/dev/null)
function detach_meh {
  sleep 63
  rm -r /tmp/user
  rm -r /tmp/trigger.asc
  rm -r /tmp/unlocked
  pkill gpg-agent
}
(detach_meh &)&
###############################################################################################################################################################################################################
elif [[ ${USER} == "user" ]];then
echo "unlucky..."
fi
###############################################################################################################################################################################################################
