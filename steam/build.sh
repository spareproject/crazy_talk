!/bin/env bash
###############################################################################################################################################################################################################
trap "exit" INT
###############################################################################################################################################################################################################
dev=${1}
boot=${dev}1
keys=${dev}2
random=${dev}3
###############################################################################################################################################################################################################
clear;cat /etc/banner
mkdir -p ./rootfs/boot
mkdir -p ./mount/
###############################################################################################################################################################################################################
if [[ ! -b ${dev} ]];then echo "${dev} doesnt exist...";fi
if [[ ${dev: -1} == [0-9] ]];then echo "takes device not partition fucked up this way more than once...";exit;fi
lsblk;unset input
while [[ ${input} != @("y"|"n") ]];do read -r -p "about to mkfs.vfat ${boot} continue (y/n)?" input;done
if [[ ${input} == "n" ]];then clear;cat /etc/banner;echo "learn to fuck up less...";exit;fi
###############################################################################################################################################################################################################
mkfs.vfat -F32 ${boot}
###############################################################################################################################################################################################################
pacstrap -C ./pacman.conf -cGMd ./rootfs $(for i in $(cat packages);do if [[ ! $(grep "#" <<< ${i}) ]];then echo -n "${i} " ;fi;done)
cp -arfv airootfs/* rootfs/
###############################################################################################################################################################################################################
mount ${boot} ./mount
mv ./rootfs/boot/* ./mount/
umount ./mount/
###############################################################################################################################################################################################################
arch-chroot ./rootfs /root/install.sh ${dev}
###############################################################################################################################################################################################################
if [[ $(ls ./rootfs/root/packages) != "" ]];then
  for i in $(ls ./rootfs/root/packages);do
    pacman -r ./rootfs -U ./rootfs/root/packages/${i}
  done
fi
#pacman -r ./rootfs -U ./rootfs/root/packages/dwm-6.0-2-x86_64.pkg.tar.xz
mount ${boot} ./mount
mksquashfs ./rootfs ./mount/rootfs.squashfs
umount ./mount
echo " quick and dirty... "
umount ./rootfs/* # incase arch-chroot doesnt shut properly
rm -r ./rootfs/*
###############################################################################################################################################################################################################
