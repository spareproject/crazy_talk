#!/bin/env bash
###############################################################################################################################################################################################################
dev=${1}
boot=${dev}1
keys=${dev}2
random=${dev}3
###############################################################################################################################################################################################################
mount ${boot} /boot
###############################################################################################################################################################################################################
#ls /boot
#read -p "ffs"
sgdisk ${dev} --attributes=1:set:2
dd bs=440 conv=notrunc count=1 if=/usr/lib/syslinux/bios/gptmbr.bin of=${dev}
mkdir /boot/syslinux
sed "s/CHANGEMEH/$(blkid ${boot} -s PARTUUID -o value)/" /root/syslinux.cfg > /boot/syslinux/syslinux.cfg
syslinux-install_update -i
###############################################################################################################################################################################################################
bootctl --path /boot install
sed "s/CHANGEMEH/$(blkid ${boot} -s PARTUUID -o value)/" /root/arch.conf > /boot/loader/entries/arch.conf
cp /root/loader.conf /boot/loader
###############################################################################################################################################################################################################
mkinitcpio -p linux-grsec
rm -r /boot/initramfs-linux-grsec-fallback.img
###############################################################################################################################################################################################################

###############################################################################################################################################################################################################
locale-gen
loadkeys uk
ln -sf /usr/share/zoneinfo/UTC /etc/localtime
if [[ -f /usr/bin/pinentry ]];then rm /usr/bin/pinentry;ln -s /usr/bin/pinentry-curses /usr/bin/pinentry;else ln -s /usr/bin/pinentry-curses /usr/bin/pinentry;fi
###############################################################################################################################################################################################################
chmod -R 700 /root
chmod -R 700 /etc/iptables
passwd -l root
###############################################################################################################################################################################################################
user=$(shuf -i 1000-65536 -n 1)
lulz=$(shuf -i 1000-65536 -n 1)
groupadd --gid ${lulz} lulz
useradd --uid ${user} -g lulz -s /bin/bash user;
chown -R user:lulz /home/user;
chmod -R 700 /home/user
passwd -l user
###############################################################################################################################################################################################################
bob=${user};lelz=${lulz}
while [[ ${bob}  == ${user} ]];do bob=$(shuf -i 1000-65536 -n 1);done
while [[ ${lelz} == ${lulz} ]];do lelz=$(shuf -i 1000-65536 -n 1);done
groupadd --gid ${lelz} lelz
useradd --uid ${bob} -g lelz -s /bin/bash bob;
chown -R bob:lelz /home/bob;
chmod -R 700 /home/bob
passwd -l bob
###############################################################################################################################################################################################################
systemctl enable iptables
systemctl enable haveged.service
systemctl enable systemd-networkd.service
systemctl enable dnscrypt-proxy
systemctl enable combine.service
###############################################################################################################################################################################################################
umount /boot
rm -r /boot
###############################################################################################################################################################################################################

###############################################################################################################################################################################################################
if [[ $(ls /root/packages) != "" ]];then
  for i in $(ls /root/packages/);do
    pacman -U /root/packages/${i}
  done
fi
###############################################################################################################################################################################################################
