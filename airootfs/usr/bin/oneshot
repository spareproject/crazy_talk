#!/bin/env bash
###############################################################################################################################################################################################################
umask 077
###############################################################################################################################################################################################################
#OLD=$(ls /dev | grep sd | cut -c 1-3 | uniq)
#read -p "plugin usb and hit enter"
#NEW=$(ls /dev | grep sd | cut -c 1-3 | uniq)
#DEV=${NEW#$OLD}
#echo $DEV
###############################################################################################################################################################################################################
clear
cat /etc/banner
while [[ ! -b /dev/archiso1 && ! -b /dev/archiso2 && ! -b /dev/archiso3 ]];do
  read -p "plugin usb... (hit enter)"
  if [[ ! -b /dev/archiso1 && ! -b /dev/archiso2 && ! -b /dev/archiso3 ]];then
    clear
    cat /etc/banner
    echo "device /dev/archiso does not exist... "
  fi
done
###############################################################################################################################################################################################################
if [[ ${USER} == "root" ]];then
#while [[ ${toggle} != @("y"|"n") ]];do read -r -p "do something y/n: " toggle;done
#if [[ ${toggle} == "y" ]];then echo stub;fi
#if [[ ${toggle} == "n" ]];then echo stub;fi
mkdir /tmp/mount
mkdir /tmp/root
mkdir /tmp/user
mkdir /tmp/sshd
mount -o ro,noload,noexec,nosuid,nodev,noatime /dev/archiso2 /tmp/mount
cp -ar /tmp/mount/root/* /tmp/root
cp -ar /tmp/mount/user/* /tmp/user
cp -ar /tmp/mount/sshd/* /tmp/sshd
cp /tmp/mount/trigger.asc /tmp
touch /tmp/unlocked
sync
umount /tmp/mount
rmdir  /tmp/mount
#while [[ ${toggle} != @("y"|"n") ]];do read -r -p "unlock root (y/n): " toggle;done
#if [[ ${toggle} == "y" ]];then
#read -rp "enter pin: " PIN
#gpg --homedir /tmp/root --passphrase-fd 0 --sign trigger.asc <<< $(dd if=/dev/archiso3 bs=1 count=100 ibs=1 skip=${PIN} 2>/dev/null)
#fi
read -rp "enter pin: " PIN
gpg --homedir /tmp/user --passphrase-fd 0 -d /tmp/trigger.asc <<< $(dd if=/dev/archiso3 bs=1 count=100 ibs=1 skip=${PIN} 2>/dev/null)
function detach_meh {
  sleep 63
  rm -r /tmp/root
  rm -r /tmp/user
  rm -r /tmp/sshd
  rm -r /tmp/trigger.asc
  rm -r /tmp/unlocked
  pkill gpg-agent
}
(detach_meh &)&
###############################################################################################################################################################################################################
elif [[ ${USER} == "user" ]];then
echo "unlucky..."
fi
###############################################################################################################################################################################################################
