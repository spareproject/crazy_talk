#!/bin/env bash
###############################################################################################################################################################################################################
if [[ $# != 2 ]];then echo -e "${0} - help\narg0 - rawfs name\narg1 - bridge name";exit;fi
###############################################################################################################################################################################################################
if [[ ! -d /mnt/mount/${1} ]];then echo "/mnt/mount/${1} doesnt exist...";exit;fi
# cant unionfs boot without it
#if [[ ! -b /dev/mapper/${1} ]];then echo "/dev/mapper/${1} doesnt exist...";exit;fi
if [[ ! $(mount | grep "/mnt/mount/${1} ") ]];then echo "mapped device isnt mounted ... ";exit;fi
###############################################################################################################################################################################################################
(/usr/bin/systemd-nspawn --quiet --boot --network-bridge ${2} --directory /mnt/mount/${1} &>/dev/null &)&
###############################################################################################################################################################################################################
# (/usr/bin/systemd-nspawn --quiet --boot --network-bridge ${2} --directory /mnt/mount/${1} --drop-capability "${CAPS}" &)&
# --whitelist - drops all caps and allows only given
# --blacklist - allows all caps and drops only given
# ^ need to take list or file for either 
# currently dropping everything breaks nspawn so apperently i have to read stuff again but default would be drop everything...
###############################################################################################################################################################################################################

# take the containers server_ca public and >> to known_hosts
# take the containers client_ca private and sign ssh/id_rsa.pub
cat /home/user/ssh/id_rsa.pub > /mnt/mount/${1}/home/user/ssh/authorized_keys


###############################################################################################################################################################################################################
# because im sick of a dirty mount dir... every call that has anything to do with my internal setup is polling mount on call...
for i in $(ls /mnt/mount);do if [[ ! $(mount | grep ${i}) ]];then rmdir /mnt/mount/${i};fi;done
###############################################################################################################################################################################################################
