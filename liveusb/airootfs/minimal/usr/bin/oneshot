#!/bin/env bash
###############################################################################################################################################################################################################
umask 077
clear;cat /etc/banner
###############################################################################################################################################################################################################
if [[ ! $(ps aux|grep gpg-agent|grep /home/user/persistent) && $(ls /home/user/persistent) == "" && -b /dev/archiso1 && -b /dev/archiso2 && -b /dev/archiso3 ]];then
mount /dev/archiso2
mount /dev/archiso3
cp -ar /home/user/mount/gnupg/persistent/* /home/user/persistent
echo -e "gnupg uptime\n1 - 1m\n2 - 5m\n3 - 10m\n4 - 15m\n"
unset input;while [[ $input != @("1"|"2"|"3"|"4") ]];do read -p "input: " input;done
if [[ ${input} == "1" ]];then timestamp="60";fi
if [[ ${input} == "2" ]];then timestamp="300";fi
if [[ ${input} == "3" ]];then timestamp="600";fi
if [[ ${input} == "4" ]];then timestamp="900";fi
sed -i "s/60/${timestamp}/" /home/user/persistent/gpg-agent.conf
read -rp "enter pin: " pin
if gpg --homedir /home/user/persistent --passphrase-fd 0 -d /home/user/mount/gnupg/trigger.asc 2>/dev/null <<< $(dd if=/home/user/random/randomfs bs=1 count=100 ibs=1 skip=${pin} 2>/dev/null);then
  echo $(($(date +%s)+${timestamp})) > /home/user/lighttpd/auth/oneshot.timestamp
  touch /home/user/unlocked
  (sleep ${timestamp} && pkill gpg-agent && rm -r /home/user/persistent/* && rm -r /home/user/unlocked &)&
else
  pkill gpg-agent
  rm -r /home/user/persistent/*
fi
umount /home/user/mount
umount /home/user/random
###############################################################################################################################################################################################################
else
  echo "!bail - dem errorz doe"
fi
