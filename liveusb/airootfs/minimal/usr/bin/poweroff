#!/bin/env bash
###############################################################################################################################################################################################################
unset input;while [[ ${input} != @("y"|"n") ]];do read -r -p "about to kill everything... continue (y/n)?" input;done
if [[ ${input} == "n" ]];then exit;fi
###############################################################################################################################################################################################################

# sed remove first line, empty lines, last line, print first column
MACHINECTL=$(machinectl|sed 1d|sed '/^$/d'|sed '$ d'|awk '{print $1}')
for i in ${MACHINECTL};do
  echo "killing machine - ${i}"
  while [[ $(machinectl|grep "${i} ") ]];do machinectl poweroff ${i};done
done

echo "unmount /mnt/mount..."
while [[ $(mount | grep /mnt/mount) ]];do    
  umount /mnt/mount/*
done

echo "close /dev/mapper"
for i in $(ls /dev/mapper/);do
  if [[ ${i} != "arch_airootfs" && ${i} != "control" ]];then
    cryptsetup close /dev/mapper/${i}
  fi
done

###############################################################################################################################################################################################################
