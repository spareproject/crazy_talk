#!/bin/env bash
###############################################################################################################################################################################################################

# gpg-agent not running, persistent empty exit
if [[ ! $(ps aux|grep gpg-agent|grep /home/user/gnupg/persistent) || $(ls /home/user/gnupg/persistent) == "" ]];then echo "gnupg not loaded";exit;fi

# luks or rawfs doesnt exist exit
if [[ ! -f "/mnt/$(blkid /dev/archiso2 -s PARTUUID -o value).luks" || ! -f "/mnt/$(blkid /dev/archiso2 -s PARTUUID -o value).rawfs" ]];then echo "does not exist...";exit;fi

###############################################################################################################################################################################################################

mkdir -p /mnt/container

gpg --homedir /home/user/gnupg/persistent -d /mnt/$(blkid /dev/archiso2 -s PARTUUID -o value).luks 2>/dev/null|
cryptsetup --cipher aes-xts-plain64 --key-size 512 --hash sha512 --iter-time 5000 --key-file - --type=plain --offset 0 open /mnt/$(blkid /dev/archiso2 -s PARTUUID -o value).rawfs container

mount /dev/mapper/container /mnt/container

if [[ -p /mnt/ip.socket ]];then rm /mnt/ip.socket;fi
if [[ -f /mnt/ip.txt ]];then rm /mnt/ip.txt;fi
mkfifo /mnt/ip.socket
touch /mnt/ip.txt

function listen {
nc -vulnzp 31279 1>/dev/null 2>/mnt/ip.socket
}
(listen &)&
function socket {
while true;do
if read line </mnt/ip.socket;then
line=$(echo "$line"|awk '{print $4}'|awk -F ':' '{print $1}')
if [[ $(wc -l </mnt/ip.txt) -gt 9 ]];then sed -i 1d /mnt/ip.txt;fi
echo $line >> /mnt/ip.txt
fi
done
}
(socket &)&
exit
###############################################################################################################################################################################################################
