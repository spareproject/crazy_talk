#!/bin/env bash
###############################################################################################################################################################################################################
umask 077
###############################################################################################################################################################################################################

# gpg-agent not running, persistent empty exit
if [[ ! $(ps aux|grep gpg-agent|grep /home/user/gnupg/persistent) || $(ls /home/user/gnupg/persistent) == "" ]];then echo "gnupg not loaded";exit;fi

# luks or rawfs doesnt exist exit
if [[ ! -f "/mnt/$(blkid /dev/archiso2 -s PARTUUID -o value).luks" || ! -f "/mnt/$(blkid /dev/archiso2 -s PARTUUID -o value).rawfs" ]];then echo "does not exist...";exit;fi

###############################################################################################################################################################################################################

mkdir -p /mnt/container

gpg --homedir /home/user/gnupg/persistent -d /mnt/$(blkid /dev/archiso2 -s PARTUUID -o value).luks 2>/dev/null|
cryptsetup --cipher aes-xts-plain64 --key-size 512 --hash sha512 --iter-time 5000 --key-file - --type=plain --offset 0 open /mnt/$(blkid /dev/archiso2 -s PARTUUID -o value).rawfs container

mount /dev/mapper/container /mnt/container

###############################################################################################################################################################################################################
