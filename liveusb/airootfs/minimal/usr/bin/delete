#!/bin/env bash
###############################################################################################################################################################################################################
if [[ $# != 1 ]];then
echo "
${0} - help
arg0 - rawfs name
"
exit
fi
###############################################################################################################################################################################################################

# if its running
if [[ $(machinectl|grep "${1} ") ]];then
  while [[ $(machinectl | grep "${1} ") ]];do
    machinectl poweroff ${1}
  done
fi

# if its unionfs
#
# mount|grep unionfs|grep name
# ^ only problem was node1 node 11 would trigger
# search for underlay |grep "name\."
# search for overlay  |grep "\.name"
# then your fault if you fuck the naming scheme up
#

# if its mounted
if [[ $(mount|grep "/mnt/mount/${1} ") ]];then
 while [[ $(mount | grep "/mnt/mount/${1} ") ]];do
   umount /mnt/mount/${1}
 done
fi

# if its mapped
if [[ -b /dev/mapper/${1} ]];then
  while [[ -b /dev/mapper/${1} ]];do
    cryptsetup close /dev/mapper/${1}
  done
fi


###############################################################################################################################################################################################################
unset finish;while [[ ${finish} != @("y"|"n") ]];do read -r -p "/mnt/rawfs/${1}|/mnt/luks/${1}|/mnt/mount/${1}  continue (y/n)? " finish;done
if [[ ${finish} == n ]];then exit;fi
if [[ ${finish} == y ]];then
if [[ -f /mnt/rawfs/${1} ]];then echo "deleting /mnt/rawfs/${1}";rm /mnt/rawfs/${1};fi
if [[ -f /mnt/luks/${1} ]];then echo "deleting /mnt/luks/${1}";rm /mnt/luks/${1};fi
if [[ -d /mnt/mount/${1} ]];then echo "deleting /mnt/mount/${1}";rmdir /mnt/mount/${1};fi
fi
###############################################################################################################################################################################################################
for i in $(ls /mnt/mount);do if [[ ! $(mount | grep ${i}) ]];then rmdir /mnt/mount/${i};fi;done
###############################################################################################################################################################################################################
