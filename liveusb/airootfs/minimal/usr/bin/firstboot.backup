#!/bin/env bash
###############################################################################################################################################################################################################

#check
###############################################################################################################################################################################################################
trap "exit" SIGINT
umask 077
###############################################################################################################################################################################################################
clear;cat /etc/banner
while [[ ! -b /dev/archiso1 && ! -b /dev/archiso2 && ! -b /dev/archiso3 ]];do
read -p "plugin usb... (hit enter)"
if [[ ! -b /dev/archiso1 && ! -b /dev/archiso2 && ! -b /dev/archiso3 ]];then clear;cat /etc/banner;echo "device /dev/archiso does not exist... ";fi
done
###############################################################################################################################################################################################################

#setup
###############################################################################################################################################################################################################
mount /dev/archiso2
mount /dev/archiso3
###############################################################################################################################################################################################################

#gnupg
###############################################################################################################################################################################################################
cp -ar /home/user/mount/gnupg/persistent/* /home/user/persistent
read -rp "enter pin: " persistent
gpg --homedir /home/user/persistent --passphrase-fd 0 -d /home/user/mount/gnupg/trigger.asc <<< $(dd if=/home/user/random/randomfs bs=1 count=100 ibs=1 skip=${persistent} 2>/dev/null)
cp /home/user/mount/gnupg/root.public       /home/user/
cp /home/user/mount/gnupg/persistent.public /home/user/persistent.public
cp /home/user/mount/gnupg/persistent.sig    /home/user/persistent.sig
gpg --homedir /home/user/persistent --output /home/user/user.sig --sign /home/user/user.public
gpg --homedir /home/user/gnupg --import /home/user/persistent.public
gpg --homedir /home/user/gnupg --sign-key persistent
###############################################################################################################################################################################################################

#openssh
###############################################################################################################################################################################################################
cp /home/user/mount/openssh/server_ca.pub   /home/user/ssh/
cp /home/user/mount/openssh/client_ca.pub   /home/user/sshd/
cp /home/user/mount/openssh/known_hosts     /home/user/ssh/
echo -e "Server Certificate Uptime\n1 - 1 hour\n2 - 1 day\n3 - 1 week\n4 - 1 month\n5 - 1 year\n"
unset toggle;while [[ ${toggle} != @("1"|"2"|"3"|"4"|"5") ]];do read -p "input: " toggle;done
if [[ ${toggle} == "1" ]];then timestamp="+1h";fi
if [[ ${toggle} == "2" ]];then timestamp="+1d";fi
if [[ ${toggle} == "3" ]];then timestamp="+1w";fi
if [[ ${toggle} == "4" ]];then timestamp="+4w";fi
if [[ ${toggle} == "5" ]];then timestamp="+52w";fi
echo "$(gpg --homedir /home/user/persistent -d /home/user/mount/openssh/server_ca.asc 2>/dev/null)"|
ssh-keygen -s /dev/stdin -I server_ca -h -n host -V ${timestamp} /home/user/sshd/ssh_host_rsa_key.pub
echo -e "Client Certificate Uptime\n1 - 1 hour\n2 - 1 day\n3 - 1 week\n4 - 1 month\n5 - 1 year\n"
unset toggle;while [[ ${toggle} != @("1"|"2"|"3"|"4"|"5") ]];do read -p "input: " toggle;done
if [[ ${toggle} == "1" ]];then timestamp="+1h";fi
if [[ ${toggle} == "2" ]];then timestamp="+1d";fi
if [[ ${toggle} == "3" ]];then timestamp="+1w";fi
if [[ ${toggle} == "4" ]];then timestamp="+4w";fi
if [[ ${toggle} == "5" ]];then timestamp="+52w";fi
echo "$(gpg --homedir /home/user/persistent -d /home/user/mount/openssh/client_ca.asc 2>/dev/null)"|
ssh-keygen -s /dev/stdin -I user -n user -V ${timestamp} /home/user/ssh/id_rsa.pub
###############################################################################################################################################################################################################

# openssl
###############################################################################################################################################################################################################
touch /home/user/openssl/index.txt
echo 1001 > /home/user/openssl/serial
touch /home/user/openssl/.random
echo -e "Webserver Certificate Uptime\n1 - 1 day\n2 - 1 week\n3 - 1 month\n4 - 1 year\n"
unset toggle;while [[ ${toggle} != @("1"|"2"|"3"|"4"|"5") ]];do read -p "input: " toggle;done
if [[ ${toggle} == "1" ]];then timestamp="1";fi
if [[ ${toggle} == "2" ]];then timestamp="7";fi
if [[ ${toggle} == "3" ]];then timestamp="30";fi
if [[ ${toggle} == "4" ]];then timestamp="365";fi
openssl req -config /home/user/mount/openssl/persistent.cnf -new -sha256 -key /home/user/lighttpd/ssl/localhost.key -out /home/user/lighttpd/ssl/localhost.csr -subj '/CN=localhost'
openssl ca  -config /home/user/mount/openssl/persistent.cnf -extensions server -days ${timestamp} -notext -md sha256 -in /home/user/lighttpd/ssl/localhost.csr -out /home/user/lighttpd/ssl/localhost.cert
cat /home/user/lighttpd/ssl/localhost.key /home/user/lighttpd/ssl/localhost.cert > /home/user/lighttpd/ssl/localhost.pem
rm /home/user/lighttpd/ssl/localhost.key
rm /home/user/lighttpd/ssl/localhost.cert
rm /home/user/lighttpd/ssl/localhost.csr
cp /home/user/mount/openssl/ca-certificates.crt /home/user/lighttpd/ssl/
###############################################################################################################################################################################################################

###############################################################################################################################################################################################################
sync
pkill gpg-agent
umount /home/user/mount
umount /home/user/random
rm -r  /home/user/persistent/*
rm -r /home/user/openssl/*
###############################################################################################################################################################################################################
#mkdir /home/user/persistent
chown -R user:group /home/user/
chmod -R 700 /home/user/
###############################################################################################################################################################################################################

###############################################################################################################################################################################################################
systemctl start sshd@user
systemctl start lighttpd
sleep 1
systemctl status sshd@user
systemctl status lighttpd
###############################################################################################################################################################################################################
