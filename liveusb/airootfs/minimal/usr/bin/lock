#!/bin/env bash
###############################################################################################################################################################################################################

# if /mnt/container is mounted and mapped
if [[ ! -b /dev/mapper/container ]];then echo "container isnt mapped";exit;fi
if [[ ! $(mount|grep /mnt/container) ]];then echo "container isnt mounted";exit;fi

# kill any gpg-agent stragglers
kill $(ps aux|grep gpg-agent|grep '/mnt/container/gnupg/persistent'|awk '{print $2}')
kill $(ps aux|grep gpg-agent|grep '/mnt/container/gnupg/revoke'|awk '{print $2}')
kill $(ps aux|grep gpg-agent|grep '/mnt/container/gnupg/root'|awk '{print $2}')

# nothing else should hang it...

###############################################################################################################################################################################################################

umount /mnt/container
cryptsetup close /dev/mapper/container

echo "done"

###############################################################################################################################################################################################################
