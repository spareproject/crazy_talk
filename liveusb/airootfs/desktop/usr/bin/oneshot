#!/bin/env bash
###############################################################################################################################################################################################################
umask 077
###############################################################################################################################################################################################################
clear;cat /etc/banner
while [[ ! -b /dev/archiso1 && ! -b /dev/archiso2 && ! -b /dev/archiso3 ]];do
read -p "plugin usb... (hit enter)"
if [[ ! -b /dev/archiso1 && ! -b /dev/archiso2 && ! -b /dev/archiso3 ]];then clear;cat /etc/banner;echo "device /dev/archiso does not exist... ";fi
done
###############################################################################################################################################################################################################
if [[ ! -d /tmp/mount ]];then mkdir /tmp/mount;fi
if [[ ! -d /tmp/random ]];then mkdir /tmp/random;fi
if [[ ! -d /tmp/user ]];then mkdir /tmp/user;fi
if touch /tmp/user/test;then rm /tmp/user/test;else echo "cant write to /tmp/user !bail...";exit;fi
mount /dev/archiso2
mount /dev/archiso3
###############################################################################################################################################################################################################
cp -ar /tmp/mount/user/* /tmp/user
cp /tmp/mount/trigger.asc /tmp
###############################################################################################################################################################################################################
read -rp "enter pin: " PIN
gpg --homedir /tmp/user --passphrase-fd 0 -d /tmp/trigger.asc 2>/dev/null <<< $(dd if=/tmp/random/randomfs bs=1 count=100 ibs=1 skip=${PIN} 2>/dev/null)
###############################################################################################################################################################################################################
touch /tmp/unlocked
sync
umount /tmp/mount
rmdir  /tmp/mount
umount /tmp/random
rmdir  /tmp/random
###############################################################################################################################################################################################################
function detach_meh {
  sleep 63
  rm -r /tmp/user
  rm -r /tmp/trigger.asc
  rm -r /tmp/unlocked
  pkill gpg-agent
}
(detach_meh &)&
###############################################################################################################################################################################################################
