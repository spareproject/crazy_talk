#!/bin/env bash
###############################################################################################################################################################################################################
umask 077
###############################################################################################################################################################################################################
clear;cat /etc/banner
while [[ ! -b /dev/archiso1 && ! -b /dev/archiso2 && ! -b /dev/archiso3 ]];do
read -p "plugin usb... (hit enter)"
if [[ ! -b /dev/archiso1 && ! -b /dev/archiso2 && ! -b /dev/archiso3 ]];then clear;cat /etc/banner;echo "device /dev/archiso does not exist... ";fi
done
###############################################################################################################################################################################################################
mount /dev/archiso2
mount /dev/archiso3
###############################################################################################################################################################################################################
cp -ar /home/user/mount/gnupg/persistent/* /home/user/persistent
###############################################################################################################################################################################################################
read -rp "enter pin: " PIN
gpg --homedir /home/user/persistent --passphrase-fd 0 -d /home/user/mount/gnupg/trigger.asc 2>/dev/null <<< $(dd if=/home/user/random/randomfs bs=1 count=100 ibs=1 skip=${PIN} 2>/dev/null)
###############################################################################################################################################################################################################
touch /home/user/unlocked
umount /home/user/mount
umount /home/user/random
###############################################################################################################################################################################################################
function detach_meh {
  sleep 63
  rm -r /home/user/persistent/*
  rm -r /home/user/unlocked
  umask 077
  pkill gpg-agent
  mkdir /home/user/persistent
}
(detach_meh &)&
###############################################################################################################################################################################################################
